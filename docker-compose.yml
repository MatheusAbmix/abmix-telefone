version: '3.8'

services:
  abmix:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: abmix-voip
    restart: unless-stopped
    
    # IMPORTANTE: Network mode host para permitir SIP/UDP
    # Necessário para comunicação SIP na porta 5060/udp
    network_mode: host
    
    # Alternativa se host mode não funcionar:
    # ports:
    #   - "5000:5000"       # HTTP/WebSocket
    #   - "6060:6060/udp"   # SIP client (padrão, veja FALEVONO_SIP_PORT)
    #   - "10000-10100:10000-10100/udp"  # RTP media ports
    
    environment:
      - NODE_ENV=production
      - PORT=5000
      
      # Public IP for RTP (CRÍTICO para áudio funcionar)
      - PUBLIC_IP=${PUBLIC_IP}
      
      # FaleVono Credentials (OBRIGATÓRIO)
      - FALEVONO_PASSWORD=${FALEVONO_PASSWORD}
      
      # Porta SIP Cliente (OPCIONAL - padrão: 6060)
      # Altere se outra aplicação estiver usando a porta 6060
      - FALEVONO_SIP_PORT=${FALEVONO_SIP_PORT:-6060}
      
      # AI Services (OBRIGATÓRIO)
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}
      
    volumes:
      # Persistir banco de dados SQLite
      - ./data:/app/data
      
      # Persistir gravações (se houver)
      - ./recordings:/app/recordings
    
    # Logs
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # Health check (usando wget)
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# Se você quiser usar volumes nomeados ao invés de bind mounts:
# volumes:
#   abmix-data:
#   abmix-recordings:
